angular.module("fact-client.directives",["fact-client.directives.stream-list","fact-client.directives.simple-slideshow"]),angular.module("fact-client.services",["fact-client.services.dataset","fact-client.services.feed","fact-client.services.resource","fact-client.services.room","fact-client.services.stream"]),angular.module("fact-client.templates",[]),angular.module("fact-client.services.dataset",[]).service("FactRDFDataset",["$resource","FACT_API_URL",function(t){var e=t(config.api+"/datasets/rdf",{},{query:{url:config.api+"/datasets/rdf",method:"GET",isArray:!0,transformResponse:function(t){return angular.fromJson(t).results}}});return e}]),angular.module("fact-client.services.feed",[]).service("FactFeed",["config","$resource","$http","$rootScope","$q","Room",function(t,e,n,r,i,o){function a(t){return t.state=t.lastRun.error?"error":t.lastRun.running?"running":t.lastRun.date?t.lastRun.cancel?"cancelled":"done":"new",t.readonly=_.contains(["running","done","error"],t.state),t}var s=e(t.api+"/feed/:feedId",{feedId:"@_id"},{query:{method:"GET",isArray:!0,transformResponse:function(t){return _.map(angular.fromJson(t).results,a)}},get:{method:"GET",isArray:!1},update:{method:"PUT",isArray:!1},create:{method:"post"}});return s.prototype.$save=function(t,e){return this._id?this.$update(t,e):this.$create(t,e)},s.prototype.follow=function(){var t=this;o.join(t._id).then(function(e){t.room=e,t.room.on(function(e){r.$apply(function(){$.extend(!0,t,e),a(t)})})})},s.prototype.run=function(){n.put(t.api+"/feed/"+this._id+"/run")},s.prototype.cancel=function(){n.put(t.api+"/feed/"+this._id+"/cancel")},s.prototype.state="new",s.prototype.readonly=!1,s}]),angular.module("fact-client.services.resource",[]).service("FactResource",["$resource","$log","$http","FACT_API_URL",function(t,e,n,r){function i(t){return _.mapValues(t,function(t){return _.object(_.map(t.terms,function(t){return[t.term,t.count]}))})}var o=t(r+"/resource/:_id",{},{query:{method:"GET",isArray:!1,params:{facets:{types:{terms:{field:"types"}},dataKeys:{terms:{field:"dataKeys"}}}},transformResponse:function(t){var e=angular.fromJson(t);return{total:e.hits.total,hits:e.hits.hits,facets:i(e.facets)}}}});return o.histogram=function(t){return n({method:"GET",url:r+"/resource/",params:{facets:{0:{date_histogram:{field:"history.date",interval:"1m"},global:!0,facet_filter:{fquery:{query:{filtered:{query:{query_string:{query:"history.feed:"+t}},filter:{bool:{must:[{match_all:{}}]}}}}}}}}},transformResponse:function(t){return[{key:"Serie 1",values:angular.fromJson(t).facets[0].entries}]}})},o}]),angular.module("fact-client.services.room",[]).service("FactRoom",["$q","$rootScope","$window","$log","FACT_API_WS",function(t,e,n,r,i){function o(t){this._id=t,this.callbacks=[]}var a={},s={};r.debug("primus connecting to "+i);var c=new Primus(i);c.on("data",function(t){r.debug("receiving data from primus",t),t.room&&(t.room in s&&t.content&&s[t.room].fire(t.content),t.room in a&&"join"===t.action&&(s[t.room]=new o(t.room),e.$apply(function(){a[t.room].cb.resolve(s[t.room])}),delete a[t.room]))}),o.prototype.on=function(t){this.callbacks.push(t)},o.prototype.removeListeners=function(){this.callbacks=[]},o.prototype.fire=function(t){_.each(this.callbacks,function(e){e(t)})};var u={};return u.join=function(e){if(e in a)return a[e].cb.promise;var n=t.defer();if(e in s)return n.resolve(s[e]),n.promise;a[e]={time:new Date,cb:n};var r={action:"join",room:e};return c.write(r),n.promise},u.leave=function(t){var e={action:"leave",room:t._id};c.write(e),delete this.rooms[t._id]},u}]),angular.module("fact-client.services.stream",["ngResource","fact-client.services.room"]).service("FactStream",["$resource","$rootScope","FactRoom","FACT_API_URL",function(t,e,n,r){var i=t(r+"/factstream/:streamId",{streamId:"@_id"},{query:{method:"GET",isArray:!0,transformResponse:function(t){return angular.fromJson(t).results}},get:{method:"GET",isArray:!1},update:{method:"PUT",isArray:!1},create:{method:"post"}});return i.prototype.$save=function(t,e){return this._id?this.$update(t,e):this.$create(t,e)},i.prototype.followVariant=function(t){var r=this;n.join(r._id+"_"+t).then(function(n){n.on(function(n){e.$apply(function(){r.variantsLastFact=r.variantsLastFact||{},r.variantsLastFact[t]=n})})})},i}]),function(t,e,n){e[t]=n.call(e),"undefined"!=typeof module&&module.exports?module.exports=e[t]:"function"==typeof define&&define.amd&&define(function(){return e[t]})}("Primus",this,function(){"use strict";function t(){this._events={}}function e(t,e){if(!(t instanceof n)){var r=new Error("Primus#"+e+"'s context should called with a Primus instance");if("function"!=typeof t.listeners||!t.listeners("error").length)throw r;t.emit("error",r)}}function n(e,i){if(!(this instanceof n))return new n(e,i);if("function"!=typeof this.client){var a="The client library has not been compiled correctly, see https://github.com/primus/primus#client-library for more details";return this.critical(new Error(a))}"object"==typeof e?(i=e,e=i.url||i.uri||r):i=i||{};var s=this;i.timeout="timeout"in i?i.timeout:1e4,i.reconnect="reconnect"in i?i.reconnect:{},i.ping="ping"in i?i.ping:25e3,i.pong="pong"in i?i.pong:1e4,i.strategy="strategy"in i?i.strategy:[],i.transport="transport"in i?i.transport:{},s.buffer=[],s.writable=!0,s.readable=!0,s.url=s.parse(e||r),s.readyState=n.CLOSED,s.options=i,s.timers={},s.attempt=null,s.socket=null,s.latency=0,s.transport=i.transport,s.transformers={outgoing:[],incoming:[]},"string"==typeof i.strategy&&(i.strategy=i.strategy.split(/\s?\,\s?/g)),!1===i.strategy?i.strategy=[]:i.strategy.length||(i.strategy.push("disconnect","online"),this.authorization||i.strategy.push("timeout")),i.strategy=i.strategy.join(",").toLowerCase(),o||t.call(s),"websockets"in i&&(s.AVOID_WEBSOCKETS=!i.websockets),"network"in i&&(s.NETWORK_EVENTS=i.network),i.manual||(s.timers.open=setTimeout(function(){s.clearTimeout("open").open()},0)),s.initialise(i)}t.prototype.listeners=function(t){return Array.apply(this,this._events[t]||[])},t.prototype.emit=function(t,e,n,r,i,o){if(!this._events||!this._events[t])return!1;var a,s,c=this._events[t],u=c.length,l=arguments.length,p=c[0];if(1===u){switch(l){case 1:p.call(p.context||this);break;case 2:p.call(p.context||this,e);break;case 3:p.call(p.context||this,e,n);break;case 4:p.call(p.context||this,e,n,r);break;case 5:p.call(p.context||this,e,n,r,i);break;case 6:p.call(p.context||this,e,n,r,i,o);break;default:for(s=1,a=new Array(l-1);l>s;s++)a[s-1]=arguments[s];p.apply(p.context||this,a)}p.once&&this.removeListener(t,p)}else{for(s=1,a=new Array(l-1);l>s;s++)a[s-1]=arguments[s];for(s=0;u>s;p=c[++s])p.apply(p.context||this,a),p.once&&this.removeListener(t,p)}return!0},t.prototype.on=function(t,e,n){return this._events||(this._events={}),this._events[t]||(this._events[t]=[]),e.context=n,this._events[t].push(e),this},t.prototype.once=function(t,e,n){return e.once=!0,this.on(t,e,n)},t.prototype.removeListener=function(t,e){if(!this._events||!this._events[t])return this;for(var n=this._events[t],r=[],i=0,o=n.length;o>i;i++)e&&n[i]!==e&&n[i].fn!==e&&r.push(n[i]);return this._events[t]=r.length?r:null,this},t.prototype.removeAllListeners=function(t){return this._events?(t?this._events[t]=null:this._events={},this):this},t.prototype.off=t.prototype.removeListener,t.prototype.addListener=t.prototype.on,t.prototype.setMaxListeners=function(){return this};var r;try{r=location.origin?location.origin:location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")}catch(i){r="http://127.0.0.1"}n.require=function(t){return"function"!=typeof require?void 0:"function"==typeof define&&define.amd?void 0:require(t)};var o,a;try{n.Stream=o=n.require("stream"),a=n.require("url").parse,n.require("util").inherits(n,o)}catch(i){n.Stream=t,n.prototype=new t,a=function(t){var e,n=document.createElement("a"),r={};n.href=t;for(e in n)("string"==typeof n[e]||"number"==typeof n[e])&&(r[e]=n[e]);if(r.port||(r.href||(r.href=""),r.port=(r.href.match(/\:/g)||[]).length>1?r.href.split(":")[2].split("/")[0]:"https"===r.href.substr(0,5)?443:80),~r.href.indexOf("@")&&!r.auth){var i=r.protocol.length+2;r.auth=r.href.slice(i,r.href.indexOf(r.pathname,i)).split("@")[0]}return r}}n.OPENING=1,n.CLOSED=2,n.OPEN=3,n.prototype.AVOID_WEBSOCKETS=!1,n.prototype.NETWORK_EVENTS=!1,n.prototype.online=!0;try{(n.prototype.NETWORK_EVENTS="onLine"in navigator&&(window.addEventListener||document.body.attachEvent))&&(navigator.onLine||(n.prototype.online=!1))}catch(i){}if(n.prototype.ark={},n.prototype.plugin=function(t){if(e(this,"plugin"),t)return this.ark[t];var n={};for(t in this.ark)n[t]=this.ark[t];return n},n.prototype.reserved=function(t){return/^(incoming|outgoing)::/.test(t)||t in this.reserved.events},n.prototype.reserved.events={readyStateChange:1,reconnecting:1,reconnect:1,offline:1,timeout:1,online:1,error:1,close:1,open:1,data:1,end:1},n.prototype.initialise=function(t){function e(){o.online&&(o.online=!1,o.emit("offline"),o.end())}function r(){o.online||(o.online=!0,o.emit("online"),~o.options.strategy.indexOf("online")&&o.reconnect())}var i,o=this;o.on("outgoing::open",function(){var t=o.readyState;o.readyState=n.OPENING,t!==n.OPENING&&o.emit("readyStateChange"),i=+new Date}),o.on("incoming::open",function(){o.attempt&&(o.attempt=null);var t=o.readyState;if(o.readyState=n.OPEN,t!==n.OPEN&&o.emit("readyStateChange"),o.emit("open"),o.clearTimeout("ping","pong").heartbeat(),o.buffer.length){for(var e=0,r=o.buffer.length;r>e;e++)o.write(o.buffer[e]);o.buffer.length=0}o.latency=+new Date-i}),o.on("incoming::pong",function(t){o.online=!0,o.clearTimeout("pong").heartbeat(),o.latency=+new Date-t}),o.on("incoming::error",function(t){var e=o.timers.connect;return o.attempt?o.reconnect():(o.listeners("error").length&&o.emit("error",t),void(e&&(~o.options.strategy.indexOf("timeout")?o.reconnect():o.end())))}),o.on("incoming::data",function(t){o.decoder(t,function(e,n){if(e)return o.listeners("error").length&&o.emit("error",e);if(!o.protocol(n)){for(var r=0,i=o.transformers.incoming.length;i>r;r++){var a={data:n};if(!1===o.transformers.incoming[r].call(o,a))return;n=a.data}o.emit("data",n,t)}})}),o.on("incoming::end",function(){var t=o.readyState;if(o.readyState=n.CLOSED,t!==n.CLOSED&&o.emit("readyStateChange"),o.timers.connect&&o.end(),t===n.OPEN){for(var e in this.timers)this.clearTimeout(e);o.emit("close"),~o.options.strategy.indexOf("disconnect")&&o.reconnect()}}),o.client();for(var a in o.ark)o.ark[a].call(o,o,t);return o.NETWORK_EVENTS?(window.addEventListener?(window.addEventListener("offline",e,!1),window.addEventListener("online",r,!1)):document.body.attachEvent&&(document.body.attachEvent("onoffline",e),document.body.attachEvent("ononline",r)),o):o},n.prototype.protocol=function(t){if("string"!=typeof t||0!==t.indexOf("primus::"))return!1;var e=t.indexOf(":",8),n=t.slice(e+2);switch(t.slice(8,e)){case"pong":this.emit("incoming::pong",n);break;case"server":"close"===n&&this.end();break;case"id":this.emit("incoming::id",n);break;default:return!1}return!0},n.prototype.id=function(t){return this.socket&&this.socket.id?t(this.socket.id):(this.write("primus::id::"),this.once("incoming::id",t))},n.prototype.open=function(){return e(this,"open"),!this.attempt&&this.options.timeout&&this.timeout(),this.emit("outgoing::open")},n.prototype.write=function(t){var r,i=this;if(e(i,"write"),n.OPEN===i.readyState){for(var o=0,a=i.transformers.outgoing.length;a>o;o++){if(r={data:t},!1===i.transformers.outgoing[o].call(i,r))return;t=r.data}i.encoder(t,function(t,e){return t?i.listeners("error").length&&i.emit("error",t):void i.emit("outgoing::data",e)})}else i.buffer.push(t);return!0},n.prototype.heartbeat=function(){function t(){n.clearTimeout("pong"),n.online&&(n.online=!1,n.emit("offline"),n.emit("incoming::end"))}function e(){n.clearTimeout("ping").write("primus::ping::"+ +new Date),n.emit("outgoing::ping"),n.timers.pong=setTimeout(t,n.options.pong)}var n=this;return n.options.ping?void(n.timers.ping=setTimeout(e,n.options.ping)):n},n.prototype.timeout=function(){function t(){e.removeListener("error",t).removeListener("open",t).removeListener("end",t).clearTimeout("connect")}var e=this;return e.timers.connect=setTimeout(function(){t(),n.readyState===n.OPEN||e.attempt||(e.emit("timeout"),~e.options.strategy.indexOf("timeout")?e.reconnect():e.end())},e.options.timeout),e.on("error",t).on("open",t).on("end",t)},n.prototype.clearTimeout=function(){for(var t=arguments,e=0,n=t.length;n>e;e++)this.timers[t[e]]&&clearTimeout(this.timers[t[e]]),delete this.timers[t[e]];return this},n.prototype.backoff=function(t,e){e=e||{};var n=this;return e.backoff?n:(e.maxDelay="maxDelay"in e?e.maxDelay:1/0,e.minDelay="minDelay"in e?e.minDelay:500,e.retries="retries"in e?e.retries:10,e.attempt=(+e.attempt||0)+1,e.factor="factor"in e?e.factor:2,e.attempt>e.retries?(t(new Error("Unable to retry"),e),n):(e.backoff=!0,e.timeout=1!==e.attempt?Math.min(Math.round((Math.random()+1)*e.minDelay*Math.pow(e.factor,e.attempt)),e.maxDelay):e.minDelay,n.emit("reconnecting",e),n.timers.reconnect=setTimeout(function(){e.backoff=!1,n.clearTimeout("reconnect"),t(void 0,e)},e.timeout),n))},n.prototype.reconnect=function(){var t=this;return t.attempt=t.attempt||t.clone(t.options.reconnect),t.backoff(function(e,n){return e?(t.attempt=null,t.emit("end")):(t.emit("reconnect",n),void t.emit("outgoing::reconnect"))},t.attempt),t},n.prototype.end=function(t){if(e(this,"end"),this.readyState===n.CLOSED&&!this.timers.connect)return this;t&&this.write(t),this.writable=!1;var r=this.readyState;this.readyState=n.CLOSED,r!==n.CLOSED&&this.emit("readyStateChange");for(var i in this.timers)this.clearTimeout(i);return this.emit("outgoing::end"),this.emit("close"),this.emit("end"),this},n.prototype.clone=function(t){return this.merge({},t)},n.prototype.merge=function(t){for(var e,n,r=Array.prototype.slice.call(arguments,1),i=0,o=r.length;o>i;i++){n=r[i];for(e in n)n.hasOwnProperty(e)&&(t[e]=n[e])}return t},n.prototype.parse=a,n.prototype.querystring=function(t){for(var e,n=/([^=?&]+)=([^&]*)/g,r={};e=n.exec(t);r[e[1]]=e[2]);return r},n.prototype.uri=function(t,e){var n=this.url,r=[];return"string"==typeof t&&(t={protocol:t},e&&(t.query=e)),t=t||{},t.protocol="protocol"in t?t.protocol:"http",t.query=n.search&&"query"in t?"?"===n.search.charAt(0)?n.search.slice(1):n.search:!1,t.secure="secure"in t?t.secure:"https:"===n.protocol,t.auth="auth"in t?t.auth:n.auth,t.pathname="pathname"in t?t.pathname:this.pathname.slice(1),t.port="port"in t?t.port:n.port||(t.secure?443:80),t.host="host"in t?t.host:n.hostname||n.host.replace(":"+n.port,""),r.push(t.secure?t.protocol+"s:":t.protocol+":",""),r.push(t.auth?t.auth+"@"+n.host:n.host),t.pathname&&r.push(t.pathname),t.query&&r.push("?"+t.query),t.object?t:r.join("/")},n.prototype.emits=function(t,e){var n=this;return function(r){var i=e?e.apply(n,arguments):r;setTimeout(function(){n.emit("incoming::"+t,i)},0)}},n.prototype.transform=function(t,n){return e(this,"transform"),t in this.transformers?(this.transformers[t].push(n),this):this.critical(new Error("Invalid transformer type"))},n.prototype.critical=function(t){if(this.listeners("error").length)return this.emit("error",t),this;throw t},n.connect=function(t,e){return new n(t,e)},n.EventEmitter=t,n.prototype.client=function(){var t,e=this,r=function(){if("undefined"!=typeof WebSocket)return WebSocket;if("undefined"!=typeof MozWebSocket)return MozWebSocket;try{return n.require("ws")}catch(t){}return void 0}();return r?(e.on("outgoing::open",function(){t&&t.close();try{e.socket=t=3===r.length?new r(e.uri({protocol:"ws",query:!0}),[],e.transport):new r(e.uri({protocol:"ws",query:!0}))}catch(n){return e.emit("error",n)}t.binaryType="arraybuffer",t.onopen=e.emits("open"),t.onerror=e.emits("error"),t.onclose=e.emits("end"),t.onmessage=e.emits("data",function(t){return t.data})}),e.on("outgoing::data",function(n){if(t&&t.readyState===r.OPEN)try{t.send(n)}catch(i){e.emit("incoming::error",i)}}),e.on("outgoing::reconnect",function(){t&&e.emit("outgoing::end"),e.emit("outgoing::open")}),void e.on("outgoing::end",function(){t&&(t.close(),t=null)})):e.critical(new Error("Missing required `ws` module. Please run `npm install --save ws`"))},n.prototype.authorization=!1,n.prototype.pathname="/primus",n.prototype.encoder=function(t,e){var n;try{t=JSON.stringify(t)}catch(r){n=r}e(n,t)},n.prototype.decoder=function(t,e){var n;try{t=JSON.parse(t)}catch(r){n=r}e(n,t)},n.prototype.version="2.0.4","object"==typeof JSON&&"function"==typeof JSON.stringify&&'["\u2028\u2029"]'===JSON.stringify(["\u2028\u2029"])&&(JSON.stringify=function(t){var e=/\u2028/g,n=/\u2029/g;return function(r,i,o){var a=t.call(this,r,i,o);return a&&(~a.indexOf("\u2028")&&(a=a.replace(e,"\\u2028")),~a.indexOf("\u2029")&&(a=a.replace(n,"\\u2029"))),a}}(JSON.stringify)),"undefined"!=typeof document&&"undefined"!=typeof navigator){document.addEventListener&&document.addEventListener("keydown",function(t){27===t.keyCode&&t.preventDefault&&t.preventDefault()},!1);var s=(navigator.userAgent||"").toLowerCase(),c=s.match(/.+(?:rv|it|ra|ie)[\/: ](\d+)\.(\d+)(?:\.(\d+))?/)||[],u=+[c[1],c[2]].join(".");!~s.indexOf("chrome")&&~s.indexOf("safari")&&534.54>u&&(n.prototype.AVOID_WEBSOCKETS=!0)}return n}),angular.module("fact-client.directives.simple-slideshow",["ngAnimate"]).directive("factSimpleSlideshow",["$timeout","$log","FACT_API_URL",function(t,e,n){return{restrict:"EA",templateUrl:"directives/fact-simple-slideshow/fact-simple-slideshow.html",scope:{fact:"=",preloadDelay:"=preloadDelay",slide:"=",rotate:"=",fade:"=",truncate:"="},link:function(e,r){e.baseUrl=n;var i=void 0===e.preloadDelay?0:e.preloadDelay;e.iter=0,e.imgStyles=[{},{}],e.$watch("fact",function(n,o){e.nextFact=n,t(function(){if(e.previousFact=o,e.currentFact=n,e.iter+=1,e.currentFact){var t=e.currentFact.depiction.width,i=e.currentFact.depiction.height,a=r.parent()[0],s=a.offsetWidth,c=a.offsetHeight,u=s/c/(t/i),l=e.imgStyles[e.iter%2]={};if(u>1&&e.truncate||1>u&&!e.truncate){l.width=s+"px";var p=i*(s/t);l.height=p+"px",l["margin-top"]=(c-p)/2+"px"}else{l.height=c+"px";var f=t*(c/i);l.width=f+"px",l["margin-left"]=(s-f)/2+"px"}}},i)})}}}]),angular.module("fact-client.directives.stream-list",[]).directive("factStreamList",function(){return{restrict:"EA",templateUrl:"directives/fact-stream-list/fact-stream-list.html",scope:{streams:"=",currentStream:"="},link:function(t){t.activeStream=function(e){void 0!==t.currentStream&&(t.currentStream=e)}}}}),angular.module("fact-client.templates").run(["$templateCache",function(t){t.put("directives/fact-simple-slideshow/fact-simple-slideshow.html",'<!-- Alternative display of currentFact in 2 img tags. In order to trigger the ng-hide animation. -->\n<depiction ng-class="{rotate: rotate, fade: fade, slide: slide}" ng-show="iter%2 == 1">\n	<img ng-src="{{iter%2 == 1 ? baseUrl + currentFact.depiction.url : baseUrl + previousFact.depiction.url}}" ng-style="imgStyles[1]"/>\n</depiction>\n<depiction ng-class="{rotate: rotate, fade: fade, slide: slide}" ng-show="iter%2 == 0">\n	<img ng-src="{{iter%2 == 0 ? baseUrl + currentFact.depiction.url : baseUrl + previousFact.depiction.url}}" ng-style="imgStyles[0]"/>\n</depiction>\n\n<!-- Hidden image to preload in the browser cache -->\n<img ng-src="{{baseUrl + nextFact.depiction.url}}" ng-show="false" class="preload"/>	\n\n\n')}]),angular.module("fact-client.templates").run(["$templateCache",function(t){t.put("directives/fact-stream-list/fact-stream-list.html",'<md-list>\n	<md-item ng-repeat="stream in streams" ng-class="{active: currentStream._id == stream._id}">\n		<md-item-content ng-click="activeStream(stream)" ink-ripple>\n			<div class="md-tile-left">\n				<md-progress-circular ng-if="!stream.variantsLastFact[\'fast-low-verySmall\']" mode="indeterminate"></md-progress-circular>\n				<fact-simple-slideshow\n					ng-if="stream.variantsLastFact[\'fast-low-verySmall\']"\n					fact="stream.variantsLastFact[\'fast-low-verySmall\']"\n					preload-delay="2000"\n					fade="true"\n					rotate="true"\n					truncate="true"\n				></fact-simple-slideshow>\n			</div>\n			<div class="md-tile-content">\n				<h3>{{stream.label}}</h3>\n				<p>{{stream.description}}</p>\n			</div>\n		</md-item-content>\n		<md-divider ng-if="!$last"></md-divider>\n	</md-item>\n</md-list>')}]);